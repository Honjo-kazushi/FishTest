<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ€ã‚¤ãƒ“ãƒ³ã‚°é­šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <div class="container">
    <div class="left-panel">
    <!-- â”€â”€ â‘ é­šãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¨ªä¸¦ã³ã«çµ±åˆ â”€â”€ -->
    <div class="fish-header">
      <img id="fishIcon" src="" alt="é­šã‚¢ã‚¤ã‚³ãƒ³" />
      <div class="fish-info">
        <h2>
        <span id="fishName">é­šã®åå‰</span>
        </h2>
        <p>
          <span id="fishEnglish">è‹±å</span> |
          <span id="fishFamily">é­šã®ä»²é–“</span>
        </p>
      </div>
    </div>

    <div class="fish-feature">
      <strong>ç‰¹å¾´:</strong>
        <div id="fishFeature" class="feature-text"></div>
    </div>

    <!-- â”€â”€ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ«ï¼ˆä»®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
    <div class="filter-panel small">
      <!-- ã‚«ãƒŠè¡Œãƒœã‚¿ãƒ³ -->
      <div class="kana-buttons">
        <button data-kana="ã‚">ã‚</button>
        <button data-kana="ã‹">ã‹</button>
        <button data-kana="ã•">ã•</button>
        <button data-kana="ãŸ">ãŸ</button>
        <button data-kana="ãª">ãª</button>
        <button data-kana="ã¯">ã¯</button>
        <button data-kana="ã¾">ã¾</button>
        <button data-kana="ã‚„">ã‚„</button>
        <button data-kana="ã‚‰">ã‚‰</button>
        <button data-kana="ã‚">ã‚</button>
        <button data-kana="å…¨">å…¨</button>
      </div>
      
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ -->
      <div id="filters">
        <span class="select-clear-wrapper">
          <select id="fishSelect" class="selectpicker">
           <option value="">é­šã‚’é¸æŠ</option>
          </select>
           <button type="button" class="clear-btn" data-target="fishSelect">C</button>  
        </span>
        <span class="select-clear-wrapper">
          <select id="placeSelect">
           <option value="">å ´æ‰€ã‚’é¸æŠ</option>
          </select>
           <button type="button" class="clear-btn" data-target="placeSelect">C</button>
        </span>
        <span class="select-clear-wrapper">
          <select id="groupSelect">
           <option value="">ä»²é–“ã‚’é¸æŠ</option>
          </select>
           <button type="button" class="clear-btn" data-target="groupSelect">C</button>
        </span>
      </div>
     </div>
    </div>
  <!-- ====== BEGIN: Audio Selection Modal ====== -->
  <div id="audioModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>ã‚ˆã†ã“ã FishPedia ã¸ï¼</h2>
      <p>å‹•ç”»ã®éŸ³å£°ã‚’ã‚ªãƒ³ã«ã—ã¾ã™ã‹ï¼Ÿ</p>
      <p>ã‚ªãƒ³/ã‚ªãƒ•ã¯ğŸ”Šã®ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ã§ãã¾ã™ï¼</p>
      <button id="btnAudioOn">ã‚ªãƒ³ã§é–‹å§‹</button>
      <button id="btnAudioOff">ç„¡éŸ³ã§ç¶šã‘ã‚‹</button>
    </div>
  </div>
  <!-- ====== END: Audio Selection Modal ====== -->

  <div class="right-panel">

    <div id="playerContainer" style="position: relative;">
      <div id="player"></div>
      <img id="playerOverlay"
        src="/images/color/FishpediaTitle.png"
        alt="Fishpedia ã‚¿ã‚¤ãƒˆãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: block; opacity: 1; z-index: 2; transition: opacity 0.3s ease;" />
    </div>

      <div class="controls">
  <!-- ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ -->
  <label style="margin-right: 10px; display: inline-flex; align-items: center; gap: 0.5rem;">
    é€£ç¶šå†ç”Ÿ
    <input type="checkbox" id="repeatToggle" class="toggle-button" checked />
  </label>

  <button id="muteBtn" aria-label="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">ğŸ”‡</button>
  <button onclick="prevGroup()">å‰Gr</button>
  <button onclick="prevVideo()">å‰ã¸</button>
  <button onclick="pauseVideo()">ãƒãƒ¼ã‚º</button>
  <button onclick="stopVideo()">åœæ­¢</button>
  <button onclick="playVideo()">å†ç”Ÿ</button>
  <button onclick="nextVideo()">æ¬¡ã¸</button>
  <button onclick="nextGroup()">æ¬¡Gr</button>
  </div>
      <div class="video-meta">
        <div><strong>å ´æ‰€:</strong> <span id="videoPlace"></span></div>
        <div><strong>å¹´:</strong> <span id="videoYear"></span></div>
        <div><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> <span id="videoFile"></span></div>
      </div>
    </div>

  </div>
  <div class="icon-bar" id="iconBar"></div>
 </div>
</div>

</body>

<script src="./js/fishesData.js"></script>
<script src="./js/videosData.js"></script> 
<script src="./js/groupsData.js"></script>
<script src="./js/placesData.js"></script>

<script>
const MAX_GROUP = 56;
const BASE_API_URL = "https://script.google.com/macros/s/AKfycbx9xS8N0HadBqim2MdMsW-G2HfjJ-hyMzGmSsvOuRlZx1fCJayqMJPsmbRiIcVzUSoX_g/exec";
    
// YouTube Player ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”¨
window.ytPlayer = null;
// â˜…è¿½åŠ ï¼šã‚°ãƒ«ãƒ¼ãƒ—ã®å‹•ç”»ä¸€è¦§ã‚’é™çš„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆãªã‘ã‚Œã°GASã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
async function listVideosByGroup(groupId) {
  // æœ€é€Ÿï¼šVIDEOS_BY_FISHï¼ˆFishIDâ†’é…åˆ—ï¼‰ã‹ã‚‰åˆæˆï¼ˆã™ã§ã«ä¸¦ã³æ¸ˆã¿ï¼‰
  if (typeof VIDEOS_BY_FISH === 'object' && VIDEOS_BY_FISH) {
    const fishIds = FISHES.filter(f => f.GroupID === Number(groupId)).map(f => String(f.FishID));
    const out = [];
    for (const fid of fishIds) {
      const arr = VIDEOS_BY_FISH[fid];
      if (arr && arr.length) out.push(...arr);
    }
    return out;
  }
  // æ¬¡ç‚¹ï¼šãƒ•ãƒ©ãƒƒãƒˆé…åˆ— VIDEOS ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿
  if (Array.isArray(VIDEOS) && VIDEOS.length) {
    return VIDEOS.filter(v => Number(v.GroupID) === Number(groupId));
  }
  // æœ€å¾Œã®ä¿é™ºï¼šGAS
  return fetch(`${BASE_API_URL}?action=listVideosByGroup&groupId=${groupId}`).then(r => r.json());
}

let fishes = [], videos = [];
let currentGroupId = 0;
let repeatMode = true;
let videoIds = [];
let ytPlayer;
let currentIndex = 0;
let lastPlayerState = null;
let isGroupFixed = false;    // æ‰‹å‹•ã§ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠã•ã‚ŒãŸã‚‰ true

// ç¾åœ¨ã®é¸æŠæ–‡å­—ï¼ˆ""ãªã‚‰å…¨è¡¨ç¤ºï¼‰
let currentLetter = "";

const muteBtn = document.getElementById("muteBtn");
muteBtn.addEventListener("click", () => {
  if (!window.ytPlayer) return;
  if (muteBtn.textContent === "ğŸ”‡") {
    window.ytPlayer.unMute();
    muteBtn.textContent = "ğŸ”Š";
  } else {
    window.ytPlayer.mute();
    muteBtn.textContent = "ğŸ”‡";
  }
});

function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

async function initData() {

  // é­šãƒ‡ãƒ¼ã‚¿ã¯é™çš„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰å³æ™‚å–å¾—
  fishes = FISHES;
  // 2) ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«åæ˜ 
  // ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã¯é™çš„é…åˆ—ã‹ã‚‰å³æ™‚å–å¾—
  populateGroupSelect(GROUPS);
  // 3) äº”åéŸ³ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–
  setupKanaButtons(fishes);
  // 4) æ’®å½±å ´æ‰€ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«åæ˜ 
  populatePlaceSelect(PLACES);
  // 5) é­šé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«å…¨ä»¶è¡¨ç¤º 
  populateFishSelect(fishes);
  // 6) ä¹±æ•°ã§åˆæœŸã‚°ãƒ«ãƒ¼ãƒ—IDã‚’æ±ºå®šãƒ»ã‚»ãƒƒãƒˆ
  // â‘  groupsSequence ã®å…ˆé ­ï¼‹ä¸­èº«ï¼‹æœ«å°¾ã‚’æº–å‚™
  // ï¼ˆèµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãŠã‘ã°ä»¥é™ã¯å¤‰ã‚ã‚‰ãªã„ï¼‰
  const OPENING_GROUP_ID = 999;
  // â‘  é™çš„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‹•ç”»ã®ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—IDé›†åˆã‚’ä½œæˆ
  //    VIDEOS ã¯ videosData.js ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å…¨ã‚¨ãƒ³ãƒˆãƒªã®é…åˆ—
  const availableGroupIds = new Set(VIDEOS.map(v => Number(v.GroupID)));  // :contentReference[oaicite:0]{index=0}
  // â‘¡ é™¤å¤–ã™ã‚‹å›ºå®šIDã ã‘çµã‚Šè¾¼ã¿ã€ãã‚Œä»¥å¤–ã¯ã™ã¹ã¦å‹•ç”»ã‚ã‚Šã§ãƒ•ã‚£ãƒ«ã‚¿
  const otherIds = GROUPS
    .map(g => g.groupId)
    .filter(id =>
      id !== OPENING_GROUP_ID &&  // å…ˆé ­å›ºå®š
      id !== 50 &&                // ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ
      id !== 39 &&                // ä¸æ˜
      availableGroupIds.has(id)   // å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š
    );

  // â‘¢ Fisherâ€“Yates ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    for (let i = otherIds.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [otherIds[i], otherIds[j]] = [otherIds[j], otherIds[i]];
    }
    groupSequence = [OPENING_GROUP_ID, ...otherIds, 50, 39];
    sequenceIndex = 0;
  // â‘¡ ãã®å¾Œã¯å¾“æ¥ã®é­šãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»UIæç”»â€¦
  const initialGroup = groupSequence[sequenceIndex];
    currentGroupId = initialGroup;// â€¦fetchã—ã¦ videos, videoIds ã‚’ä½œã‚‹â€¦
      
    videos = await listVideosByGroup(initialGroup);
  // ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‘å‹•ç”»ãŒã‚¼ãƒ­ä»¶ãªã‚‰æ¬¡ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è‡ªå‹•ã§æ¢ã™
    if (videos.length === 0 && initialGroup !== OPENING_GROUP_ID) {
        console.warn('[initData] no videos for group', initialGroup);
      for (let gid = 1; gid <= MAX_GROUP; gid++) {
        if (gid === initialGroup) continue;
          const tmp = await listVideosByGroup(gid); // è¿½åŠ  9/15ï¼šé™çš„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
          if (tmp.length) {
            currentGroupId = gid;
            videos = tmp;
            console.info('[initData] switched to group', gid, ' videos.length=', tmp.length);
            break;
          }
        }
      }
  // 8) ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼ã‚’æç”»ï¼ˆgroupSelect ã® change ã§ã‚‚åŒã˜å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼‰
    renderIconBar("next");
      
  // â”€â”€ è¿½åŠ : Cãƒœã‚¿ãƒ³ã§è©²å½“ã‚»ãƒ¬ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢ â”€â”€
    document.querySelectorAll('.clear-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.target;
        const sel = document.getElementById(targetId);
        sel.value = '';                     // é¸æŠè§£é™¤
        // 2) ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠä»¥å¤–ã¯ã“ã‚Œã¾ã§ã©ãŠã‚Š change ã‚’é£›ã°ã™
        if (targetId !== 'groupSelect') {
          sel.dispatchEvent(new Event('change')); // change ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
        }
      });
    });
    
  // â”€â”€ è¿½åŠ : fishSelectå¤‰æ›´æ™‚ã«Groupã¨Placeã‚’ã‚¯ãƒªã‚¢ â”€â”€
    const fishSel = document.getElementById('fishSelect');
    fishSel.addEventListener('change', () => {
      document.getElementById('groupSelect').value = '';
      document.getElementById('placeSelect').value = '';
    // å¿…è¦ã«å¿œã˜ã¦UIæ›´æ–°ï¼å‹•ç”»ã®å†ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚’ã“ã“ã§å‘¼ã³å‡ºã—
    });
    
    // ãƒˆã‚°ãƒ«åˆæœŸåŒ–ã¯ã“ã“ã§
    const toggle = document.getElementById("repeatToggle");
    repeatMode = toggle.checked;
    toggle.addEventListener("change", () => {
    repeatMode = toggle.checked;
    });

    // åˆæœŸè¡¨ç¤ºï¼šé¸æŠä¸­ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­é­šæƒ…å ±ã‚’å–å¾—
    const selectedGroup = currentGroupId;
    const groupVideos = videos.filter(v => {
    const fish = fishes.find(f => f.FishID === v.FishID);
    return fish && fish.GroupID === selectedGroup;
  });
    if (groupVideos.length > 0) {
      const firstFishId = groupVideos[0].FishID;
      const firstFish   = fishes.find(f => f.FishID === firstFishId);
      const firstVideo  = groupVideos[0];
    // æƒ…å ±è¡¨ç¤º
      updateFishInfo(firstFish);
      updateVideoMeta(firstVideo);
      
     
    // ã‚¬ãƒ¼ãƒ‰ï¼šloadVideoById ã®ç›´å‰ã«ç½®ã
    if (!window.ytPlayer || typeof window.ytPlayer.loadVideoById !== 'function') {
      console.warn('[initData] ytPlayer not ready, retrying in 100ms');
      setTimeout(initData, 100);
      return;
    }

    // å¿…è¦ã«å¿œã˜ã¦è‡ªå‹•å†ç”Ÿã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’ã‚¢ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ
    // playVideoByFish(entry.fishId, entry.videoId);
    // å‹•ç”»ã‚’ã€Œã‚»ãƒƒãƒˆã ã‘ã€ã§ã¯ãªãã€ãã®ã¾ã¾å†ç”Ÿã—ãŸã„å ´åˆ
      const vid = extractVideoId(firstVideo.YouTubeURL);
      window.ytPlayer.loadVideoById(vid);
      window.ytPlayer.playVideo();
    }
}

document.addEventListener('DOMContentLoaded', initData);

// ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠå¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼
function toKatakana(ch) {
  const code = ch.charCodeAt(0);
  // ã²ã‚‰ãŒãªç¯„å›²(ã=0x3041ï½ã‚–=0x3096)ã®ã¿å¤‰æ›
  if (code >= 0x3041 && code <= 0x3096) {
    return String.fromCharCode(code + 0x60);
  }
  return ch;
}

/*
* ã‚«ãƒŠè¡Œãƒœã‚¿ãƒ³ã«ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²ã—ã€
* æŠ¼ã•ã‚ŒãŸæ–‡å­—ã§ fishes é…åˆ—ã‚’çµã‚Šè¾¼ã‚“ã§
* é­šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†æç”»ã™ã‚‹
*/

// ã²ã‚‰ãŒãªãƒœã‚¿ãƒ³â†’å¯¾è±¡ã‚«ã‚¿ã‚«ãƒŠæ–‡å­—ç¾¤ãƒãƒƒãƒ—
const KANA_MAP = {
  "ã‚": ["ã‚¢","ã‚¤","ã‚¦","ã‚¨","ã‚ª"],
  "ã‹": ["ã‚«","ã‚­","ã‚¯","ã‚±","ã‚³"],
  "ã•": ["ã‚µ","ã‚·","ã‚¹","ã‚»","ã‚½"],
  "ãŸ": ["ã‚¿","ãƒ","ãƒ„","ãƒ†","ãƒˆ"],
  "ãª": ["ãƒŠ","ãƒ‹","ãƒŒ","ãƒ","ãƒ"],
  "ã¯": ["ãƒ","ãƒ’","ãƒ•","ãƒ˜","ãƒ›"],
  "ã¾": ["ãƒ","ãƒŸ","ãƒ ","ãƒ¡","ãƒ¢"],
  "ã‚„": ["ãƒ¤","ãƒ¦","ãƒ¨"],
  "ã‚‰": ["ãƒ©","ãƒª","ãƒ«","ãƒ¬","ãƒ­"],
  "ã‚": ["ãƒ¯","ãƒ²"],
  "å…¨": null  // å…¨ä»¶ã¯ special case
};

function setupKanaButtons(fishes) {
  const buttons = document.querySelectorAll('.kana-buttons button[data-kana]');
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const kana = btn.dataset.kana;

      // åŒãƒœã‚¿ãƒ³é€£æ‰“ã¯ç„¡è¦–
      if (kana !== 'å…¨' && btn.classList.contains('active')) return;
      // ã¾ãšå…¨ãƒœã‚¿ãƒ³ã® active ã‚’ã‚¯ãƒªã‚¢
      buttons.forEach(b => b.classList.remove('active'));

      if (kana === 'å…¨') {
        // å…¨æŠ¼ã—ï¼šå…¨ä»¶è¡¨ç¤º
        populateFishSelect(fishes);
      } else {
        // ç‰¹å®šè¡ŒæŠ¼ã—ï¼šãã®ãƒœã‚¿ãƒ³ã ã‘ active ã«ã—ã¦çµã‚Šè¾¼ã¿
        btn.classList.add('active');
        const targets = KANA_MAP[kana];
        const filtered = fishes.filter(f => targets.includes(f.Name.charAt(0)));
        populateFishSelect(filtered);
      }
    });
  });
}



/**
* ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–ã™ã‚‹
* @param {Array<{groupId: number, nameJp: string}>} allGroups
*/
function populateGroupSelect(allGroups) {

  // 1) ã‚»ãƒ¬ã‚¯ãƒˆè¦ç´ ã‚’å–å¾—
  const sel = document.getElementById('groupSelect');
  // 2) æ—¢å­˜ã®<option>ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€Œå…¨ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚’è¿½åŠ 
  sel.innerHTML = '<option value="">å…¨ã‚°ãƒ«ãƒ¼ãƒ—</option>';
  // â”€â”€ â‘  é™çš„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œå‹•ç”»ã®ã‚ã‚‹ã€ã‚°ãƒ«ãƒ¼ãƒ—IDé›†åˆã‚’ä½œã‚‹
  const availableGroupIds = new Set(VIDEOS.map(v => Number(v.GroupID)));
  // ã€Œä¸æ˜ã€ã¨ã€Œãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã€ã‚’åˆ‡ã‚Šå‡ºã™
  const unknownGroup  = allGroups.find(g => g.nameJp === 'ä¸æ˜');
  const digestGroup   = allGroups.find(g => g.nameJp === 'ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ');
  // â”€â”€ â‘¡ ã€Œä¸æ˜ï¼ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã€ã‚’é™¤ãã€ã‹ã¤å‹•ç”»ã‚ã‚Šã®ã‚°ãƒ«ãƒ¼ãƒ—ã ã‘æŠ½å‡º
  const otherGroups = allGroups.filter(g =>
    g.nameJp !== 'ä¸æ˜' &&
    g.nameJp !== 'ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ' &&
    availableGroupIds.has(g.groupId)
  );
      
  // ä»–ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’äº”åéŸ³ã§ã‚½ãƒ¼ãƒˆã—ã¦è¿½åŠ 
  otherGroups
    .sort((a, b) => a.nameJp.localeCompare(b.nameJp, 'ja'))
    .forEach(g => {
      const opt = document.createElement('option');
      opt.value       = g.groupId;
      opt.textContent = g.nameJp;
      sel.appendChild(opt);
    });
  // ã€Œä¸æ˜ã€ãŒã‚ã‚Œã°è¿½åŠ 
  if (unknownGroup) {
    const opt = document.createElement('option');
    opt.value       = unknownGroup.groupId;
    opt.textContent = unknownGroup.nameJp;
    sel.appendChild(opt);
  }
  // ã€Œãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã€ãŒã‚ã‚Œã°è¿½åŠ 
  if (digestGroup) {
    const opt = document.createElement('option');
    opt.value       = digestGroup.groupId;
    opt.textContent = digestGroup.nameJp;
    sel.appendChild(opt);
  }

  sel.addEventListener('change', async (e) => {
  // æ‰‹å‹•ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠæ™‚ã¯ fishSelect ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('fishSelect').value = '';
    currentGroupId = Number(e.target.value);
    // æ–°ã‚°ãƒ«ãƒ¼ãƒ—ã®å‹•ç”»ãƒªã‚¹ãƒˆå–å¾—
    videos = await listVideosByGroup(currentGroupId); // è¿½åŠ  9/15ï¼šé™çš„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
    // å‹•ç”»ã‚­ãƒ¥ãƒ¼ã‚’å¿…ãšæ›´æ–°
    videoIds = videos.map(v => ({
      videoId: extractVideoId(v.YouTubeURL),
      fishId:  v.FishID
     }));

    currentIndex = 0;
    renderIconBar("next");
    isGroupFixed = false;  //ä»•æ§˜å¤‰æ›´ï¼šã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚³ãƒ³ãƒœã§é¸ã°ã‚ŒãŸã‚‰ã€é ­å‡ºã—ã®ã¿ã®æ©Ÿèƒ½ã¨ã™ã‚‹
    // å…ˆé ­å‹•ç”»ã‚’å†ç”Ÿ
    currentIndex = 0;
    const entry = videoIds[0];
    if (entry) {
      const vid   = entry.videoId;
      if (repeatMode && vid) {
        window.ytPlayer.loadVideoById(vid);
        window.ytPlayer.playVideo();
      } else {
        window.ytPlayer.cueVideoById(vid);               
      }
      // è¡¨ç¤ºæƒ…å ±ã®æ›´æ–°
      const fishMeta = fishes.find(f => f.FishID === entry.fishId);
      if (fishMeta) updateFishInfo(fishMeta);
        const meta = videos.find(v => extractVideoId(v.YouTubeURL) === entry.videoId);
        if (meta) updateVideoMeta(meta);
      }
    });
}
        
  
function populatePlaceSelect(list) {
  const sel = document.getElementById('placeSelect');
  sel.innerHTML = '<option value="">å…¨å ´æ‰€</option>';
  list.forEach(p => {
    const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
    // å¤‰æ›´â†’ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼å†æç”»
    sel.addEventListener('change', () => {
    // ã€è¿½åŠ ã€‘Placeå¤‰æ›´æ™‚ã¯ fishSelect ã‚’ã‚¯ãƒªã‚¢
      const fishSel = document.getElementById('fishSelect');
      fishSel.value = '';
      renderIconBar("next");
    });
  }

function populateFishSelect(list) {
  const sel = document.getElementById('fishSelect');
  sel.innerHTML = '';
  list.sort((a, b) => a.Name.localeCompare(b.Name, 'ja'));
       
  // å…ˆé ­ã«ãƒ€ãƒŸãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªã‚‰ï¼‰
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'â€” é­šã‚’é¸æŠ â€”';
  sel.appendChild(placeholder);
      
  list.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.FishID;
    opt.textContent = f.Name;
    sel.appendChild(opt);
  });
    
  // â”€â”€ è¿½åŠ ï¼šé­šé¸æŠ change æ™‚ã®ä¸€é€£å‡¦ç† â”€â”€
  let fishSel = document.getElementById('fishSelect');
  // æ—¢å­˜ã®åŒ¿åãƒªã‚¹ãƒŠã¯å‰Šé™¤ã—ã¦ã„ã‚‹æƒ³å®š
  fishSel.replaceWith(fishSel.cloneNode(true));
  fishSel = document.getElementById('fishSelect'); // å†ä»£å…¥
  fishSel.addEventListener('change', async e => {
  // 1) ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
  document.getElementById('groupSelect').value = '';
  document.getElementById('placeSelect').value = '';
  // 2) é¸æŠé­šâ†’ã‚°ãƒ«ãƒ¼ãƒ—åˆ¤å®š
  const fishId = Number(e.target.value);
  const fishObj = fishes.find(f => f.FishID === fishId);
  if (!fishObj) return;
    const groupId = fishObj.GroupID;
  // 3) ã‚°ãƒ«ãƒ¼ãƒ—ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰å‹•ç”»ã‚’å†å–å¾—
    if (groupId !== currentGroupId) {
      currentGroupId = groupId;
      videos = await listVideosByGroup(groupId).catch(()=>[]);
      videoIds = videos.map(v => ({
      fishId:  v.FishID,
      videoId: extractVideoId(v.YouTubeURL)
      }));
    }
 
  // â”€â”€ é­šé¸æŠæ™‚ã®é ­å‡ºã—ä½ç½®è¨­å®š â”€â”€
  // ä»•æ§˜å¤‰æ›´ï¼šé­šé¸æŠã¯é ­ã ã—ã®ã¿ã®æ©Ÿèƒ½ã«å¤‰æ›´ã€€ã‚°ãƒ«ãƒ¼ãƒ—å…¨å‹•ç”»ã¯ãã®ã¾ã¾ä¿æŒã—ã€currentIndex ã«å¯¾è±¡é­šã®å…ˆé ­å‹•ç”»ã‚’ã‚»ãƒƒãƒˆ
  const idx = videoIds.findIndex(v => v.fishId === fishId);
  currentIndex = idx >= 0 ? idx : 0;
      
  // 4) ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼å†æç”»â†’ãƒ¡ã‚¿æ›´æ–°â†’å†ç”Ÿ or ã‚­ãƒ¥ãƒ¼
  renderIconBar("next");
  updateFishInfo(fishObj);
  //ä»•æ§˜å¤‰æ›´ï¼šé­šé¸æŠã¯é ­ã ã—ã®ã¿ã®æ©Ÿèƒ½ã«å¤‰æ›´
  const entry = videoIds[currentIndex];
    if (entry) {
      const meta = videos.find(v =>
        extractVideoId(v.YouTubeURL) === entry.videoId
        );
      if (repeatMode) {
        window.ytPlayer.loadVideoById(entry.videoId);
        window.ytPlayer.playVideo();
      } else {
        window.ytPlayer.cueVideoById(entry.videoId);
      }
      if (meta) updateVideoMeta(meta);
    }
  //ä»•æ§˜å¤‰æ›´ï¼šé­šé¸æŠã¯é ­ã ã—ã ã‘ã®æ©Ÿèƒ½ã«å¤‰æ›´
    isGroupFixed = false;
    });
}

function onGroupChange(e) {
  const gid = e.target.value;
  // groupId ã§çµã£ãŸé­šä¸€è¦§ã‚’å†è¡¨ç¤º
  const filtered = gid ? Fishes.filter(f=>f.GroupID==gid) : Fishes;
  populateFishSelect(filtered);
}

function onPlaceChange(e) {
  const place = e.target.value;
  document.querySelectorAll('.fish-icon').forEach(img => {
  // â‘  data-fish-id å±æ€§ã‹ã‚‰ ID ã‚’å–å¾—
  const fid = Number(img.dataset.fishId);

  // â‘¡ ãã®é­šã®å‹•ç”»ãƒªã‚¹ãƒˆã®ä¸­ã«è©²å½“å ´æ‰€ãŒã‚ã‚‹ã‹èª¿ã¹ã‚‹
  const hasAtPlace = videos.some(v =>
    v.FishID === fid && v.æ’®å½±å ´æ‰€ === place
  );

  // â‘¢ fishes ãƒã‚¹ã‚¿ã‚’å‚ç…§ã—ã¦ã‚«ãƒ©ãƒ¼ï¼ã‚°ãƒ¬ã‚¤ã‚’åˆ‡ã‚Šæ›¿ãˆ
  const fishMeta = fishes.find(f => f.FishID === fid);
    if (fishMeta) {
      img.src = hasAtPlace
        ? fishMeta.IconURL
        : fishMeta.IconInactiveURL;
      }
    });
}    

function onYouTubeIframeAPIReady() {
  window.ytPlayer = new YT.Player("player", {
    height: "360",
    width: "640",

    playerVars: {
      /*ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã¨ãã€æœ¬ãƒãƒ£ãƒ³ã§ã¯ç„¡éŸ³ã§ãªã„ã¨è‡ªå‹•å†ç”Ÿã—ãªã„ */
      autoplay: 1,     // è‡ªå‹•å†ç”Ÿè¦æ±‚ï¼ˆãƒãƒªã‚·ãƒ¼åˆ¤å®šç”¨ï¼‰
      mute: 1,         // ãƒŸãƒ¥ãƒ¼ãƒˆæŒ‡å®š
      playsinline: 1,  // iOSã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å†ç”Ÿ
    
      controls:        0,  // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º
      disablekb:       1,  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œç„¡åŠ¹åŒ–
      modestbranding:  1,  // ãƒ­ã‚´æœ€å°è¡¨ç¤º
      rel:             0,  // é–¢é€£å‹•ç”»éè¡¨ç¤º
      fs:              0,  // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³éè¡¨ç¤º
      iv_load_policy:  3,  // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³éè¡¨ç¤º
      enablejsapi:     1,
      origin:          window.location.origin,   

  },
    // åœæ­¢æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åˆ¶å¾¡ã‚’è¡Œã†
  events: {
    onStateChange: onPlayerStateChange,
  },
});
}

/**
 * #iconBar å†…ã«é­šã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸¦ã¹ã‚‹(åå‰ã€æ’®å½±å¹´ã€å ´æ‰€é †)
 * - videos: ç¾åœ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å‹•ç”»ãƒªã‚¹ãƒˆï¼ˆFishID, YouTubeURL,... ã®é…åˆ—ï¼‰
 * - fishes: å…¨é­šãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆFishID, Name, IconURL,... ã®é…åˆ—ï¼‰
 */
/**
 * ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼æç”»ï¼‹å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚¹ã‚­ãƒƒãƒ—
 * @param {"next"|"prev"} direction - ã‚¹ã‚­ãƒƒãƒ—æ–¹å‘
 */
function renderIconBar(direction) {
//function renderIconBar() {
  const bar = document.getElementById('iconBar');
  bar.innerHTML = '';           // ä¸€æ—¦ã‚¯ãƒªã‚¢
  const selectedPlace = document.getElementById('placeSelect').value;

  // 1) ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç”¨ã«ã€Group å†…ã®é­šIDã‚’ã‚ãƒ¼ã‚é †ã§ä¸¦ã¹æ›¿ãˆ
  // videos ãŒ undefined ã§ã‚‚ç©ºé…åˆ—ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const safeVideos = Array.isArray(videos) ? videos : [];
  // undefined ã‚„ null ã‚’é™¤å¤–ã—ã¦ FishID ã‚’æŠ½å‡º
  const fishIds = Array.from(
    new Set(
      safeVideos
        .filter(v => v != null && typeof v.FishID !== 'undefined')
        .map(v => v.FishID)
    )
  );

  const sortedFishIds = fishIds
    .map(id => fishes.find(f => f.FishID === id))
    .sort((a, b) => a.Name.localeCompare(b.Name, 'ja'))
    .map(f => f.FishID)

  sortedFishIds.forEach(fid => {
    const fish = fishes.find(f => f.FishID === fid);
    if (!fish) return;

    const wrapper = document.createElement('div');
    wrapper.classList.add('fish-icon-wrapper');

    const img = document.createElement('img');
    img.dataset.fishId = fid;
    // é¸æŠå ´æ‰€ãŒã‚ã‚Œã°ã€ãã®é­šã«è©²å½“å ´æ‰€ã®å‹•ç”»ãŒã‚ã‚‹ã‹ã§è‰²ï¼ã‚°ãƒ¬ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
    const atPlace = selectedPlace
      ? videos.some(v => v.FishID === fid && v.æ’®å½±å ´æ‰€ === selectedPlace)
      : true;
    img.src = atPlace ? fish.IconURL : fish.IconInactiveURL;
    img.alt = fish.Name;
    img.classList.add('fish-icon');

    img.addEventListener('click', () => {

    const fishSel = document.getElementById('fishSelect');
    const selectedFish = fishSel.value;
    const place = document.getElementById('placeSelect').value;
    // é­šæœªé¸æŠã‹ã¤å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿ã§éè©²å½“ï¼ˆç°è‰²ï¼‰ã®å ´åˆã¯ç„¡è¦–
    if (!selectedFish && place && entry.æ’®å½±å ´æ‰€ !== place) return;
    // fishSelect ã«ã‚»ãƒƒãƒˆã—ã¦ change ç™ºç«
    fishSel.value = fid;
    fishSel.dispatchEvent(new Event('change'));
    });
    wrapper.appendChild(img);

    // é­šåãƒ©ãƒ™ãƒ«
    const label = document.createElement('div');
    label.classList.add('fish-label');
    label.textContent = fish.Name;
    wrapper.appendChild(label);

    // ãƒãƒ¼ã«è¿½åŠ 
    bar.appendChild(wrapper);

  });

   if (!document.getElementById('fishSelect').value) {

      // å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿ï¼šé¸æŠãŒã‚ã‚Œã°ãã®å ´æ‰€ã®å‹•ç”»ã®ã¿ã€ãªã‘ã‚Œã°æ¬¡ã‚°ãƒ«ãƒ¼ãƒ—ã‹å‰ã‚°ãƒ«ãƒ¼ãƒ—ã¸
      const sel = document.getElementById('placeSelect').value;
      const filteredVideos = sel
        ? videos.filter(v => v.æ’®å½±å ´æ‰€ === sel)
        : videos.slice();
      
      if (sel && filteredVideos.length === 0) {
       console.warn('[renderIconBar] no videos at place, skipping', currentGroupId);
       return direction === 'prev' ? prevGroup() : nextGroup();
      }

      const sortedVideos = filteredVideos.slice().sort((a, b) => {
//    const sortedVideos = videos.slice().sort((a, b) => {
       // 1) é­šåï¼ˆã‚ãƒ¼ã‚é †ï¼‰
       const fa = fishes.find(f => f.FishID === a.FishID);
       const fb = fishes.find(f => f.FishID === b.FishID);
       let cmp = fa.Name.localeCompare(fb.Name, 'ja');
       if (cmp !== 0) return cmp;
       // 2) åŒã˜é­šãªã‚‰æ’®å½±å¹´ï¼ˆæ•°å€¤æ˜‡é †ï¼‰
       cmp = Number(a.æ’®å½±å¹´) - Number(b.æ’®å½±å¹´);
       if (cmp !== 0) return cmp;
       // 3) æ’®å½±å ´æ‰€ï¼ˆPLACES é…åˆ—ã®é †åºï¼‰
       const idxA = PLACES.indexOf(a.æ’®å½±å ´æ‰€);
       const idxB = PLACES.indexOf(b.æ’®å½±å ´æ‰€);
       return idxA - idxB;
    });
     videoIds = sortedVideos.map(v => ({
       fishId: v.FishID,
       videoId: extractVideoId(v.YouTubeURL)
    }));
  }
 }
 
function getRandomGroupId() {
  return Math.floor(Math.random() * MAX_GROUP) + 1;
}

function extractVideoId(url) {
  const match = url?.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/))([a-zA-Z0-9_-]{11})/);
  return match ? match[1] : "";
}

function updateFishInfo(fish) {
  document.getElementById("fishName").textContent = fish.Name;
  document.getElementById("fishEnglish").textContent = fish.è‹±å || "";
  document.getElementById("fishFamily").textContent = fish["é­šã®ä»²é–“"] || "";
  document.getElementById("fishFeature").textContent = fish.ç‰¹å¾´ || "";
  document.getElementById("fishIcon").src = fish.IconURL;
}

function updateVideoMeta(video) {
  document.getElementById("videoPlace").textContent = video.æ’®å½±å ´æ‰€ || "";
  document.getElementById("videoYear").textContent = video.æ’®å½±å¹´ || "";
  document.getElementById("videoFile").textContent = video.å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«å || "";
}

// â€” ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾— â€”
const audioModal = document.getElementById('audioModal');
const btnOn  = document.getElementById('btnAudioOn');
const btnOff = document.getElementById('btnAudioOff');

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function showAudioModal() {
  return new Promise(resolve => {
    audioModal.style.display = 'flex';
    const clean = () => {
      audioModal.style.display = 'none';
      btnOn.removeEventListener('click', onOn);
      btnOff.removeEventListener('click', onOff);
    };
    const onOn = () => { clean(); resolve('on'); };
    const onOff = () => { clean(); resolve('off'); };
    btnOn.addEventListener('click', onOn);
    btnOff.addEventListener('click', onOff);
  });
}


/**
 * fishId ã®å‹•ç”»ã‚’å†ç”Ÿã¾ãŸã¯ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²ã—ã€æƒ…å ±æ›´æ–°ã‚‚è¡Œã†
 * @param {number} fishId
 * @param {string} videoId
 * @param {boolean} play  å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ãªã‚‰ trueï¼ˆloadï¼‰ã€falseãªã‚‰ cue
 */
function playVideoByFish(fishId, videoId) {
  console.log('[playVideoByFish] called with', { fishId, videoId });
  const fish = fishes.find(f => f.FishID === fishId);
   // find the specific video record
  const video = videos.find(v =>
    v.FishID === fishId &&
    extractVideoId(v.YouTubeURL) === videoId
  );
  // determine the index within videoIds
  const entryIndex = videoIds.findIndex(v =>
    v.fishId === fishId && v.videoId === videoId
  );
  if (entryIndex !== -1 && video) {
    currentIndex = entryIndex;
    // load and play the exact video
    if (repeatMode) {
      window.ytPlayer.loadVideoById(videoId);
      window.ytPlayer.playVideo();
    } else {
      window.ytPlayer.cueVideoById(videoId);
    }
        
    document.getElementById("playerOverlay").style.display = "none";
    document.getElementById("playerOverlay").style.opacity = "0";
    updateFishInfo(fish);
    updateVideoMeta(video);
  }
}

let lastState = null;
  
/**
 * YouTube ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹
 */
function onPlayerStateChange(event) {
  const overlay = document.getElementById("playerOverlay");

  // â”€â”€ é€šå¸¸ã‚¹ãƒ†ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â”€â”€
  switch (event.data) {
    case YT.PlayerState.ENDED:

    // â”€â”€ å…ˆã«ã‚¬ãƒ¼ãƒ‰ã—ã¦ãŠã â”€â”€
      if (!videoIds[currentIndex]) {
        console.warn('no entry at index', currentIndex, 'queue=', videoIds);
        return;
      }
     // å†ç”Ÿçµ‚äº†æ™‚ã®é€£ç¶šå†ç”Ÿå‡¦ç†
      if (repeatMode) {
        if (currentIndex < videoIds.length - 1) {
          // åŒã‚°ãƒ«ãƒ¼ãƒ—å†…ã®æ¬¡å‹•ç”»ã¸
          nextVideo();
        } else {
          // â”€â”€ æ‰‹å‹•é¸æŠæ™‚å›ºå®šãƒ¢ãƒ¼ãƒ‰ãªã‚‰åŒã‚°ãƒ«ãƒ¼ãƒ—é ­ã«æˆ»ã™ â”€â”€
          if (isGroupFixed) {
              currentIndex = 0;
              const entry0 = videoIds[0];
              playVideoByFish(entry0.fishId, entry0.videoId);
            } else {
              if (currentGroupId === OPENING_GROUP_ID) {
              // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šæ¬¡ã‚°ãƒ«ãƒ¼ãƒ—ã¸
                nextGroup();
              // ï¼’ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã ã‘è¡¨ç¤ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã‚’ä¿ƒã™

              const playerInstance = event.target;
              showAudioModal().then(choice => {
                if (choice === 'on') {
                  if (playerInstance.getPlayerState() === YT.PlayerState.PLAYING) {
                    playerInstance.pauseVideo();
                  }
                  playerInstance.unMute();               // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ãƒ•ãƒ©ã‚°
                  muteBtn.textContent = "ğŸ”Š";
                  // å†åº¦å†ç”Ÿå‘½ä»¤ã‚’å‡ºã™
                  playerInstance.playVideo();    
                } else {
                  playerInstance.mute();                 // ç„¡éŸ³ç¶™ç¶š
                }
              });                
              } else {
              // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šæ¬¡ã‚°ãƒ«ãƒ¼ãƒ—ã¸
                nextGroup();
              }  
            }
        }
      } else {
        // repeatMode OFF â†’ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã®ã¿
        overlay.style.display = 'block';
        overlay.style.opacity = '1';
      }
      break;

    case YT.PlayerState.PLAYING:
      // å†ç”Ÿé–‹å§‹ â†’ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã™
      overlay.style.display = 'none';
      overlay.style.opacity = '0';
      // â”€â”€ è¿½åŠ ï¼šå†ç”Ÿé–‹å§‹æ™‚ã«ãƒ¡ã‚¿æƒ…å ±ã‚’æ›´æ–° â”€â”€
      // currentIndex ã¯ç¾åœ¨å†ç”Ÿä¸­ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      const entry = videoIds[currentIndex];
      // fishes ã¨ videos ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      const fish  = fishes.find(f => f.FishID === entry.fishId);
      const video = videos.find(v =>
        v.FishID === entry.fishId &&
        extractVideoId(v.YouTubeURL) === entry.videoId
      );
      if (fish && video) {
        updateFishInfo(fish);
        updateVideoMeta(video);
      }
      break;

    case YT.PlayerState.UNSTARTED:
      // å¼·åˆ¶åœæ­¢ã‚„ãƒªã‚»ãƒƒãƒˆãªã©ã‚’æ¤œçŸ¥
      if (
        lastPlayerState === YT.PlayerState.PLAYING ||
        lastPlayerState === YT.PlayerState.PAUSED
      ) {
        overlay.style.display = 'block';
        overlay.style.opacity = '1';
      }
      break;

    // å¿…è¦ã«å¿œã˜ã¦ PAUSED, BUFFERING ç­‰ã‚‚è¿½åŠ å¯èƒ½
  }

  // çŠ¶æ…‹ã‚’è¨˜éŒ²
  lastPlayerState = event.data;
}


function playVideo() {window.ytPlayer.playVideo(); }
function pauseVideo() { window.ytPlayer.pauseVideo(); }
function stopVideo() { window.ytPlayer.stopVideo(); }

function nextVideo() {

  if (currentIndex < videoIds.length - 1) {
    // åŒã‚°ãƒ«ãƒ¼ãƒ—å†…ã®æ¬¡å‹•ç”»ã¸
    currentIndex++;
    const entry = videoIds[currentIndex];
    console.log('[nextVideo] playing entry', entry);

  // â–¶ï¸ loadâ†’play ãƒ•ãƒ­ãƒ¼ã«å§”è­²
    playVideoByFish(entry.fishId, entry.videoId);
  
  } else {
  // ã‚°ãƒ«ãƒ¼ãƒ—æœ«å°¾ â†’ æ¬¡ã‚°ãƒ«ãƒ¼ãƒ—ã¸ç§»è¡Œï¼ˆå†ç”Ÿã›ãšã‚­ãƒ¥ãƒ¼ã®ã¿ï¼‰
    nextGroup();
  }
}

function prevVideo() {
  if (currentIndex > 0) {
    // åŒã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å‰å‹•ç”»ã¸
    currentIndex--;
    const entry = videoIds[currentIndex];
    // â–¶ï¸ ä¸€æ‹¬ã§å†ç”Ÿï¼‹UIæ›´æ–°ã‚’è¡Œã†
    playVideoByFish(entry.fishId, entry.videoId);
    
  } else {
    // ã‚°ãƒ«ãƒ¼ãƒ—å…ˆé ­ â†’ å‰ã‚°ãƒ«ãƒ¼ãƒ—ã¸ç§»è¡Œï¼ˆå†ç”Ÿã›ãšã‚­ãƒ¥ãƒ¼ã®ã¿ï¼‰
    prevGroup();
  }
}

async function nextGroup() {
// â–  ã‚°ãƒ«ãƒ¼ãƒ—ç§»å‹•æ™‚ã«ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
  document.getElementById('fishSelect').value = '';
  document.getElementById('groupSelect').value = '';

// ã€Œæ¬¡ã‚°ãƒ«ãƒ¼ãƒ—å†ç”Ÿã€ãŒå‘¼ã°ã‚ŒãŸã‚‰ã‚°ãƒ«ãƒ¼ãƒ—å›ºå®šãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
  isGroupFixed = false;

  sequenceIndex++;
  if (sequenceIndex >= groupSequence.length) {
    // ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚’é£›ã°ã—ã¦ã€ä¹±æ•°ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ã‹ã‚‰å†é–‹
    sequenceIndex = 1;
  }  
  currentGroupId = groupSequence[sequenceIndex];
      
    // 2) æ–°ã‚°ãƒ«ãƒ¼ãƒ—ã®å‹•ç”»ã‚’å–å¾—ã—ã€videoIds ã‚’å†ç”Ÿæˆ
  try {
    videos = await listVideosByGroup(currentGroupId);
    
    videoIds = videos.map(v => ({
      fishId:  v.FishID,
      videoId: extractVideoId(v.YouTubeURL)
    }));
    currentIndex = 0;

    // 3) ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼ã‚’å†æç”»
    renderIconBar("next");
    // 4) å…ˆé ­å‹•ç”»ã‚’ loadâ†’play ã‚‚ã—ãã¯ cue    
    if (videoIds.length > 0) {
      const entry = videoIds[0];
      const fish  = fishes.find(f => f.FishID === entry.fishId);
      const video = videos.find(v =>
        v.FishID === entry.fishId &&
        extractVideoId(v.YouTubeURL) === entry.videoId
        );
        updateFishInfo(fish);
        updateVideoMeta(video);
        
      // repeatMode ãƒ•ãƒ©ã‚°ã§å†ç”Ÿ or ã‚­ãƒ¥ãƒ¼ã‚’æŒ¯ã‚Šåˆ†ã‘
      if (repeatMode) {
      // ã‚°ãƒ«ãƒ¼ãƒ—æœ€åˆã®å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§å†ç”Ÿ
        const vid = entry.videoId;
        if (vid) {
          window.ytPlayer.loadVideoById(vid);
          window.ytPlayer.playVideo();
        }
      } else {
      // å†ç”Ÿã›ãšã‚­ãƒ¥ãƒ¼ã ã‘
        const vid = entry.videoId;
        if (vid) {
          window.ytPlayer.cueVideoById(vid);
        }
      }
    }
  } catch (err) {
    console.error('[nextGroup] Error:', err);
    videos = [];
  }
}


async function prevGroup() {

// â–  ã‚°ãƒ«ãƒ¼ãƒ—ç§»å‹•æ™‚ã«ã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
  document.getElementById('fishSelect').value = '';
  document.getElementById('groupSelect').value = '';

  // 1) ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆ1 ã‚ˆã‚Šå°ã•ã‘ã‚Œã° MAX_GROUP ã«æˆ»ã™ï¼‰
  sequenceIndex--;
  if (sequenceIndex < 1) {
  // å…ˆé ­(ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ï¼index 0)ã®æ‰‹å‰ã¯
  // æœ«å°¾ï¼ˆä¹±æ•°ã‚°ãƒ«ãƒ¼ãƒ—æœ€å¾Œã€ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ/ä¸æ˜å«ã‚€ï¼‰ã«é£›ã°ã™
  sequenceIndex = groupSequence.length - 1;
  }
  currentGroupId = groupSequence[sequenceIndex];
      
  // 2) æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã®å‹•ç”»ä¸€è¦§ã‚’å–å¾—
  try {
    videos = await listVideosByGroup(currentGroupId);
    // â˜… videoIds ã‚’æœ€æ–°åŒ–
    videoIds = videos.map(v => ({
      fishId:  v.FishID,
      videoId: extractVideoId(v.YouTubeURL)
    }));
    currentIndex = 0;
    // 3) ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒ¼ã‚’å†æç”»
    renderIconBar("prev");
    // 4) â˜…nextGroup ã¨åŒã˜å†ç”Ÿåˆ¶å¾¡ãƒ–ãƒ­ãƒƒã‚¯
    if (videoIds.length > 0) {
      const entry = videoIds[0];
    // UI æ›´æ–°
      const fish  = fishes.find(f => f.FishID === entry.fishId);
      const video = videos.find(v =>
        v.FishID === entry.fishId &&
        extractVideoId(v.YouTubeURL) === entry.videoId
      );
      updateFishInfo(fish);
      updateVideoMeta(video);
      // repeatMode ã«å¿œã˜ã¦å†ç”Ÿ or cue
      if (repeatMode) {
        window.ytPlayer.loadVideoById(entry.videoId);
        window.ytPlayer.playVideo();
      } else {
        window.ytPlayer.cueVideoById(entry.videoId);
      }
    }
  } catch (err) {
    console.error('[nextGroup] Error:', err);
    videos = [];
  }
}  

</script>
  

<script src="https://www.youtube.com/iframe_api"></script>

</body>
</html>
